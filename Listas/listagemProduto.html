<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="/assets/js/ControledeSessao.js"></script>
        <script src="/assets/js/ApenasSessao.js"></script>
        <!-- ===== CSS ===== -->
        <link rel="stylesheet" href="../assets/css/styles.css">
        <link rel="stylesheet" href="../assets/css/ListaProduto.css">
        <link rel="icon" type="image/x-icon" href="../assets/img/file.ico">
        
        <title>Produtos</title>
    </head>
    <body class="body-telas" id="body-pd">
        <div class="l-navbar" id="navbar">
            <nav class="nav">
                <div>
                    <div class="nav__brand">
                        <ion-icon name="menu-outline" class="nav__toggle" id="nav-toggle"></ion-icon>
                        <a href="index.html" class="nav__logo">Comercialize</a>
                    </div>
                    <div class="nav__list">
                        <a href="index.html" class="nav__link active">
                            <ion-icon name="home-outline" class="nav__icon"></ion-icon>
                            <span class="nav__name">Dashboard</span>
                        </a>
                        <a href="#" class="nav__link">
                            <ion-icon name="chatbubbles-outline" class="nav__icon"></ion-icon>
                            <span class="nav__name">Messenger</span>
                        </a>

                        <div  class="nav__link collapse collapse__link">
                            <ion-icon name="folder-outline" class="nav__icon"></ion-icon>
                            <span class="nav__name">Cadastros</span>

                            <ion-icon name="chevron-down-outline" class="collapse__link"></ion-icon>

                            <ul class="collapse__menu">
                                <a href="../Cadastros/cadastrarCliente.html" class="collapse__sublink">Cliente</a>
                                <a href="../Cadastros/cadastrarProduto.html" class="collapse__sublink">Produto</a>
                                <a href="../Cadastros/cadastrarUsuario.html" class="collapse__sublink">Usuário</a>
                                <a href="../Cadastros/cadastrarEstoque.html" class="collapse__sublink">Estoque</a>
                                <a href="../Cadastros/cadastrarVendas.html" class="collapse__sublink">Vendas</a>
                            </ul>
                        </div>

                        <div  class="nav__link collapse collapse__link">
                            <ion-icon name="folder-outline" class="nav__icon"></ion-icon>
                            <span class="nav__name">Listagens</span>

                            <ion-icon name="chevron-down-outline" class="collapse__link"></ion-icon>

                            <ul class="collapse__menu">
                                <a href="../Listas/listagemCliente.html" class="collapse__sublink">Cliente</a>
                                <a href="../Listas/listagemProduto.html" class="collapse__sublink">Produto</a>
                                <a href="../Listas/listagemUsuario.html" class="collapse__sublink">Usuário</a>
                                <a href="../Listas/listagemEstoque.html" class="collapse__sublink">Estoque</a>
                                <a href="../Listas/listagemVendas.html" class="collapse__sublink">Vendas</a>
                            </ul>
                        </div>

                        <a href="#" class="nav__link">
                            <ion-icon name="pie-chart-outline" class="nav__icon"></ion-icon>
                            <span class="nav__name">Analytics</span>
                        </a>
                        <div class="nav__link collapse">
                            <ion-icon name="people-outline" class="nav__icon"></ion-icon>
                            <span class="nav__name">Team</span>

                            <ion-icon name="chevron-down-outline" class="collapse__link"></ion-icon>

                            <ul class="collapse__menu">
                                <a href="#" class="collapse__sublink">Data</a>
                                <a href="#" class="collapse__sublink">Group</a>
                                <a href="#" class="collapse__sublink">Members</a>
                            </ul>
                        </div>
                        <a href="#" class="nav__link">
                            <ion-icon name="settings-outline" class="nav__icon"></ion-icon>
                            <span class="nav__name">Configurações</span>
                        </a>
                    </div>
                </div>

                <a href="login.html" class="nav__link">
                    <ion-icon name="log-out-outline" class="nav__icon"></ion-icon>
                    <span class="nav__name">Sair</span>
                </a>
            </nav>
        </div>

        <div class="containerProduto">
            <h1 class="subtituloProduto">Produtos</h1>
            <label for="pesquisaProduto">Procurar por produto:</label>

            <ul>
                <!-- Campo de pesquisa único para ID ou nome com Combobox -->
                <div style="display: flex; align-items: center;">
                    <input type="text" id="pesquisaProduto" name="Pesquisa" placeholder="Pesquise pelo ID ou nome do produto" class="inputPesquisa">
                    <select id="filtroProduto" class="inputFiltro">
                        <option value="id">ID</option>
                        <option value="nome">Nome</option>
                    </select>
                    <input type="button" id="searchButton" value="Buscar" class="Btncad" onclick="pesquisarProduto()">
                </div>
            </ul>

            <ul><a href="../Cadastros/cadastrarProduto.html"><input type="button" value="Novo Produto" class="Btnovo"></a></ul>

            <div id="result"></div>

            <hr>

            <div>
                

                <div class="containerLista">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Nome</th>
                                <th scope="col">Valor</th>
                                <th scope="col">Descrição</th>
                                <th scope="col">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="produtos-container">
                            <!-- Os dados dos usuários serão inseridos aqui -->
                        </tbody>
                    </table>
                </div>

                
        
                <!-- Modal de Edição de Usuário -->
                <div id="editarProdutoModal" class="modal">
                    <div class="modal-content">
                        <span class="close" id="closeModal">&times;</span>
                        <h2>Editar Produto</h2>
                        <form id="editarUsuarioForm" class="form-modal">
                            <div class="form-group">
                                <label for="nomeProduto">Nome:</label>
                                <input type="text" id="nomeProduto" name="nomeProduto" required>
                                <label for="descricaoProduto">Descrição:</label>
                                <input type="text" id="descricaoProduto" name="descricaoProduto">  
                            <div class="form-group form-actions">
                                <label for="Valor">Valor:</label>
                                <input type="text" id="Valor" name="qtdProduto" required>
                            </div>
                            <div class="form-group">
                                <button type="button" id="salvarEdicao" class="btn">Salvar</button>
                            </div>
                        </form>

                <!-- <ul id="lista-produtos">Carregando produtos...</ul> -->
            </div>
        </div>

        <!-- ===== IONICONS ===== -->
        <script src="https://unpkg.com/ionicons@5.1.2/dist/ionicons.js"></script>

        <!-- ===== MAIN JS ===== -->
        <script src="../assets/js/main.js"></script>
        <script src="../assets/js/scripts.js"></script>
    </body>

    <script>
        const baseUrl = 'https://vendas-comercialize-a0fqhjhne5cagkc5.brazilsouth-01.azurewebsites.net/Produto';

        const lista = document.getElementById('lista-produtos');
        // Função para listar todos os produtos
        async function ListaProduto() {
            try {
                const resposta = await fetch(`${baseUrl}/buscar-todos-produtos`);
                if (!resposta.ok) {
                    throw new Error(`Erro ao acessar API: ${resposta.status}`);
                }
                const produtos = await resposta.json();
                const tbody = document.querySelector('#produtos-container')

                tbody.innerHTML = '';

                if(Array.isArray(produtos)) {
                    produtos.forEach(produto => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <th scope="row">${produto.idProduto}</th>
                        <td>${produto.nomeProduto}</td>
                        <td>${produto.valor}</td>
                        <td>${produto.descricao}</td>
                     <td>
                        <ion-icon name="create-outline" class="button-edit" data-id="${produto.idProduto}" onclick="editarProduto(this)">Editar</ion-icon> 
                        <ion-icon name="trash" class="button-delete" data-id="${produto.idProduto}" onclick="excluirProduto(this)">Apagar</ion-icon>
                    </td>`

                    tbody.appendChild(row);
                    })
                }else {
                console.error('A resposta não é um array:', produtos);
                }
            } catch (error){
                console.error('Ocorreu um problema na sua requisição',error)
            }
        }
            document.addEventListener('DOMContentLoaded', ListaProduto)

                // Exibir os produtos
            //    const lista = document.getElementById('lista-produtos');
        //         lista.innerHTML = ''; // Limpar lista antes de preencher

        //         produtos.forEach(produto => {
        //             const item = document.createElement('tr');
        //             item.textContent = ` ${produto.idProduto} ${produto.nomeProduto} - R$ ${produto.valor.toFixed(2)} ${produto.descricao}`;
        //             lista.appendChild(item);
        //         });
        //     } catch (erro) {
        //         console.error('Erro ao carregar produtos:', erro);
        //         document.getElementById('lista-produtos').textContent = 'Erro ao carregar produtos.';
        //     }
        // }


        // Função para buscar produtos pelo ID ou nome
        async function pesquisarProduto() {
            const pesquisaInput = document.getElementById('pesquisaProduto').value.trim();
            const filtro = document.getElementById('filtroProduto').value;
            

            // Se o campo estiver vazio, busca todos os produtos
            if (!pesquisaInput) {
                ListaProduto();
                return;
            }

            let url;

            // Se o filtro selecionado for ID, busca pelo ID
            if (filtro === 'id') {
                if (!isNaN(pesquisaInput)) {
                    // Buscar pelo ID
                    url = `${baseUrl}/buscar-produto-por-id/${pesquisaInput}`;
                } else {
                    lista.textContent = 'Por favor, insira um ID válido.';
                    return;
                }
            } else if (filtro === 'nome') {
                // Buscar pelo nome
                url = `${baseUrl}/buscar-produto-por-nome/${encodeURIComponent(pesquisaInput)}`;
            }

            try {
                const resposta = await fetch(url);
                if (!resposta.ok) {
                    throw new Error(`Erro ao acessar API: ${resposta.status}`);
                }

                const produtos = await resposta.json();
                const row = document.createElement('tr');
                const tbody = document.querySelector('#produtos-container')

                tbody.innerHTML = '';

                row.innerHTML = ''; // Limpar lista antes de preencher

                // Verificar se o produto foi encontrado
                if (!produtos || produtos.length === 0) {
                    lista.textContent = 'Nenhum produto encontrado.';
                    return;
                }

            if (filtro === 'nome') {
                
                pesquisarProdutoNome(produtos) 
            } else {
                pesquisarProdutoid(produtos)
            }
                
            } catch (erro) {
                console.error('Erro ao buscar produto:', erro);
                lista.textContent = 'Erro ao buscar produto.';
            }
        }
        async function pesquisarProdutoid(produtos) {
            const tbody = document.querySelector('#produtos-container')
            const row = document.createElement('tr');
            row.innerHTML = `
            <th scope="row">${produtos.idProduto}</th>
                        <td>${produtos.nomeProduto}</td>
                        <td>${produtos.valor}</td>
                        <td>${produtos.descricao}</td>
                     <td>
                        <ion-icon name="create-outline" class="button-edit" data-id="${produtos.idProduto}" onclick="editarUsuario(this)">Editar</ion-icon> 
                        <ion-icon name="trash" class="button-delete" data-id='${produtos.idProduto}'onclick="excluirProduto(this)">Apagar</ion-icon>
                    </td>`

                tbody.appendChild(row);
            

        }

        async function pesquisarProdutoNome(produtos) {

        produtos.forEach(produto => {
            const tbody = document.querySelector('#produtos-container')
            const row = document.createElement('tr');
                        row.innerHTML = `
                        <th scope="row">${produto.idProduto}</th>
                        <td>${produto.nomeProduto}</td>
                        <td>${produto.valor}</td>
                        <td>${produto.descricao}</td>
                     <td>
                        <ion-icon name="create-outline" class="button-edit" data-id="${produto.idProduto}" onclick="editarUsuario(this)">Editar</ion-icon> 
                        <ion-icon name="trash" class="button-delete" data-id='${produto.idProduto}'onclick="excluirProduto(this)">Apagar</ion-icon>
                    </td>`

                    tbody.appendChild(row);
        });
}


      // Carregar todos os produtos inicialmente
        ListaProduto();
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

async function editarProduto(element) {

let id = element.getAttribute('data-id');
// Abre o modal para editar o usuário
const modal = document.getElementById('editarProdutoModal');
const nomeProdutoInput = document.getElementById('nomeProduto');
const ValorInput = document.getElementById('Valor');
const descricaoInput = document.getElementById('descricaoProduto');

// Mostra o modal
modal.style.display = 'block';

// Preenche os campos com os dados do usuário selecionado
try {
    const response = await fetch(`https://vendas-comercialize-a0fqhjhne5cagkc5.brazilsouth-01.azurewebsites.net/Produto/buscar-produto-por-id/${id}`);
    if (!response.ok) {
        const errorMessage = await response.text();
        throw new Error(`Erro ao buscar Produto: ${response.status} - ${errorMessage}`);
    }

    const produto = await response.json();
    nomeProdutoInput.value = produto.nomeProduto || '';
    ValorInput.value = produto.valor || '';
    descricaoInput.value = produto.descricao || '';

} catch (error) {
    console.error('Erro ao buscar Produto:', error);
    alert('Erro ao buscar os dados do Produto. Tente novamente.');
    modal.style.display = 'none';
    return;
}

// Remove event listener duplicado antes de adicionar novamente
const salvarEdicaoButton = document.getElementById('salvarEdicao');
salvarEdicaoButton.onclick = async () => {
    const nomeProduto = nomeProdutoInput.value.trim();
    const Valor = ValorInput.value.trim();
    const descricaoProduto = descricaoInput.value.trim();

    // Valida os campos antes de enviar
    // if (!nomeProduto || !login) {
    //     alert('Por favor, preencha todos os campos.');
    //     return;
    // }

    try {
        const response = await fetch(`https://vendas-comercialize-a0fqhjhne5cagkc5.brazilsouth-01.azurewebsites.net/Produto/atualizar-produto`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                idProduto: id,
                nomeProduto: nomeProduto,
                valor: Valor,
                descricao: descricaoProduto
            })
        });

        if (!response.ok) {
            const errorMessage = await response.text();
            throw new Error(`Erro ao editar produto: ${response.status} - ${errorMessage}`);
        }

        alert('produto editado com sucesso!');
        ListaProduto(); // Atualiza a lista de usuários
        modal.style.display = 'none'; // Fecha o modal após sucesso

    } catch (error) {
        console.error('Erro ao editar o produto:', error);
        alert('Você precisa alterar todos os dados para editar o produto.');
    }
};

        document.addEventListener('DOMContentLoaded', ListaProduto);
        document.getElementById('closeModal').onclick = function() {
        document.getElementById('editarProdutoModal').style.display = 'none';
    }
}

async function excluirProduto(element) {
    let id = element.getAttribute('data-id');

    // Confirmação antes de excluir o usuário
    const confirmacao = confirm("Tem certeza que deseja excluir este produto?");
    if (!confirmacao) {
        return;
    }

    try {
        // Realiza a requisição DELETE para a API
        const response = await fetch(`https://vendas-comercialize-a0fqhjhne5cagkc5.brazilsouth-01.azurewebsites.net/Produto/remover-produto/${id}`, {
            method: 'DELETE',
        });

        if (!response.ok) {
            const errorMessage = await response.text();
            throw new Error(`Erro ao excluir produto: ${response.status} - ${errorMessage}`);
        }

        alert('produto excluído com sucesso!');
        ListaProduto(); // Atualiza a lista de usuários na interface

    } catch (error) {
        console.error('Erro ao excluir produto:', error);
        alert('Erro ao excluir o produto. Tente novamente.');
    }

    
}

        
    </script>
</html>
